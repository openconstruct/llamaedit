<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLamaEdit</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/javascript-hint.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.js"></script>

<script src="https://unpkg.com/jshint@2.13.6/dist/jshint.js"></script>
<script src="https://unpkg.com/jsonlint@1.6.3/web/jsonlint.js"></script>
<script src="https://unpkg.com/csslint@1.0.5/dist/csslint.js"></script>
<script src="https://unpkg.com/htmlhint@1.1.4/dist/htmlhint.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/javascript-lint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/json-lint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/css-lint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/html-lint.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/yaml-lint.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/go/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/lua/lua.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/perl/perl.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/php/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/r/r.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/ruby/ruby.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/rust/rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/swift/swift.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/yaml/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/typescript/typescript.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/base16-light.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/solarized.min.css">
<style>
/* --- STYLES (unchanged from original + NEW STYLES) --- */
:root {
    /* ... (color variables remain the same) ... */
    --app-bg-light: #ececec; /* System-like light background */
    --app-fg-light: #1e1e1e;
    --menu-bg-light: #f0f0f0;
    --toolbar-bg-light: #f5f5f5;
    --sidebar-bg-light: #f8f8f8;
    --statusbar-bg-light: #e0e0e0;
    --border-color-light: #cccccc;
    --button-bg-light: #e1e1e1;
    --button-hover-bg-light: #d1d1d1;
    --button-active-bg-light: #c1c1c1;
    --button-fg-light: #222222;
    --modal-bg-light: #ffffff;
    --modal-header-bg-light: #f0f0f0;
    --input-bg-light: #ffffff;
    --input-border-light: #aaaaaa;
    --input-focus-border-light: #0078d4;

    --app-bg-dark: #2d2d2d; /* System-like dark background */
    --app-fg-dark: #f1f1f1;
    --menu-bg-dark: #383838;
    --toolbar-bg-dark: #3c3c3c;
    --sidebar-bg-dark: #333333;
    --statusbar-bg-dark: #252525;
    --border-color-dark: #444444;
    --button-bg-dark: #555555;
    --button-hover-bg-dark: #666666;
    --button-active-bg-dark: #777777;
    --button-fg-dark: #e0e0e0;
    --modal-bg-dark: #424242;
    --modal-header-bg-dark: #3a3a3a;
    --input-bg-dark: #303030;
    --input-border-dark: #555555;
    --input-focus-border-dark: #0078d4;

    --app-bg: var(--app-bg-dark);
    --app-fg: var(--app-fg-dark);
    --menu-bg: var(--menu-bg-dark);
    --toolbar-bg: var(--toolbar-bg-dark);
    --sidebar-bg: var(--sidebar-bg-dark);
    --statusbar-bg: var(--statusbar-bg-dark);
    --border-color: var(--border-color-dark);
    --button-bg: var(--button-bg-dark);
    --button-hover-bg: var(--button-hover-bg-dark);
    --button-active-bg: var(--button-active-bg-dark);
    --button-fg: var(--button-fg-dark);
    --modal-bg: var(--modal-bg-dark);
    --modal-header-bg: var(--modal-header-bg-dark);
    --input-bg: var(--input-bg-dark);
    --input-border: var(--input-border-dark);
    --input-focus-border: var(--input-focus-border-dark);

    --primary-color: #8be9fd;
    --secondary-color: #bd93f9;
    --danger-color: #ff5555;
    --success-color: #50fa7b;
    --warning-color: #ffb86c;
    --info-color: #8be9fd;
}
body.theme-light {
    --app-bg: var(--app-bg-light);
    --app-fg: var(--app-fg-light);
    --menu-bg: var(--menu-bg-light);
    --toolbar-bg: var(--toolbar-bg-light);
    --sidebar-bg: var(--sidebar-bg-light);
    --statusbar-bg: var(--statusbar-bg-light);
    --border-color: var(--border-color-light);
    --button-bg: var(--button-bg-light);
    --button-hover-bg: var(--button-hover-bg-light);
    --button-active-bg: var(--button-active-bg-light);
    --button-fg: var(--button-fg-light);
    --modal-bg: var(--modal-bg-light);
    --modal-header-bg: var(--modal-header-bg-light);
    --input-bg: var(--input-bg-light);
    --input-border: var(--input-border-light);
    --input-focus-border: var(--input-focus-border-light);
}
html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--app-bg); color: var(--app-fg); transition: background-color 0.2s, color 0.2s; display: flex; flex-direction: column; }
.app-container { display: flex; flex-direction: column; height: 100%; box-sizing: border-box; overflow: hidden; }
.menu-bar { background-color: var(--menu-bg); padding: 0 5px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; height: 30px; display: flex; align-items: center; user-select: none; z-index: 10; }
ul.menu { list-style: none; padding: 0; margin: 0; display: flex; height: 100%; }
li.menu-item { position: relative; padding: 0 10px; cursor: default; display: flex; align-items: center; height: 100%; font-size: 0.85rem; transition: background-color 0.1s; }
li.menu-item:hover { background-color: var(--button-hover-bg); }
ul.submenu { display: none; position: absolute; top: 100%; left: 0; background-color: var(--menu-bg); border: 1px solid var(--border-color); border-top: none; list-style: none; padding: 5px 0; margin: 0; min-width: 180px; z-index: 100; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
li.menu-item:hover > ul.submenu { display: block; }
li.submenu-item { padding: 6px 15px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: background-color 0.1s; display: flex; justify-content: space-between; align-items: center; }
li.submenu-item:hover { background-color: var(--button-hover-bg); }
li.submenu-item.disabled { color: #888; cursor: not-allowed; background-color: transparent !important; }
li.submenu-item kbd { font-size: 0.8em; color: #777; padding-left: 15px; }
body.theme-light li.submenu-item kbd { color: #555; }
body.theme-light li.submenu-item.disabled { color: #aaa; }
.menu-separator { height: 1px; background-color: var(--border-color); margin: 5px 0; }
li.menu-item > ul.submenu > li.menu-item { position: relative; }
li.menu-item > ul.submenu > li.menu-item > ul.submenu { top: -6px; left: 100%; border-top: 1px solid var(--border-color); }
.toolbar { display: flex; gap: 5px; background-color: var(--toolbar-bg); padding: 5px 8px; border-bottom: 1px solid var(--border-color); align-items: center; flex-shrink: 0; }
.find-replace-container { display: none; gap: 8px; background-color: var(--toolbar-bg); padding: 5px 8px; border-bottom: 1px solid var(--border-color); align-items: center; flex-shrink: 0; }
.editor-container { flex: 1; display: flex; min-height: 0; overflow: hidden; }
.sidebar { width: 220px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; }
.sidebar h4 { margin: 0; padding: 8px 10px; font-size: 0.9rem; font-weight: 600; color: var(--app-fg); flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
.file-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
.file-item { padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; cursor: pointer; transition: background-color 0.1s; white-space: nowrap; border-bottom: 1px solid transparent; }
.file-item:hover { background-color: var(--button-hover-bg); }
.file-item.active { background-color: var(--input-focus-border); color: white; font-weight: 500; }
body.theme-light .file-item.active { color: white; }
.file-name { overflow: hidden; text-overflow: ellipsis; margin-right: 5px; flex-grow: 1; }
.file-name .unsaved-indicator { color: var(--warning-color); margin-left: 2px; font-weight: bold; }
.file-remove { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1rem; line-height: 1; padding: 0 4px; margin-left: auto; flex-shrink: 0; opacity: 0.6; transition: opacity 0.15s, color 0.15s; }
.file-item:hover .file-remove { opacity: 1; }
.file-item.active .file-remove { color: white; }
.file-remove:hover { color: #ff7777; opacity: 1; }
.main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; overflow: hidden; }
#editor { }
.CodeMirror { position: absolute; top: 0; left: 0; right: 0; bottom: 0; height: 100% !important; font-size: 14px; border: none; } /* font-size is now default, applied via JS */
.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler { background-color: transparent; }
.CodeMirror-vscrollbar::-webkit-scrollbar { width: 12px; }
.CodeMirror-vscrollbar::-webkit-scrollbar-track { background: var(--sidebar-bg); }
.CodeMirror-vscrollbar::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.4); border: 3px solid transparent; background-clip: content-box; border-radius: 6px;}
.CodeMirror-vscrollbar::-webkit-scrollbar-thumb:hover { background: rgba(128,128,128,0.6); }
.cm-s-dracula.CodeMirror { background-color: #282a36; }
.cm-s-dracula .CodeMirror-scrollbar-filler, .cm-s-dracula .CodeMirror-gutter-filler { background-color: #282a36; }
.cm-s-dracula .CodeMirror-vscrollbar::-webkit-scrollbar-track { background: #333338; }
.cm-s-dracula .CodeMirror-vscrollbar::-webkit-scrollbar-thumb { background-color: #44475a; }
.cm-s-dracula .CodeMirror-vscrollbar::-webkit-scrollbar-thumb:hover { background-color: #6272a4; }

/* --- Status Bar Enhancements --- */
.status-bar {
    background-color: var(--statusbar-bg);
    font-size: 0.75rem;
    color: var(--app-fg);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
    user-select: none;
    height: 22px;
    display: flex;
    justify-content: space-between;
    align-items: stretch; /* Make sections fill height */
}
.statusbar-section {
    display: flex;
    align-items: center; /* Vertically center content within section */
    padding: 0; /* Reset padding, add to individual items */
}
.statusbar-section > div { /* Style direct children divs within sections */
    padding: 0 8px;
    border-right: 1px solid var(--border-color);
    white-space: nowrap;
    display: flex;
    align-items: center;
    height: 100%; /* Make sure divs fill section height */
}
.statusbar-section > div:last-child {
    border-right: none;
}
.statusbar-left { }
.statusbar-center {
    flex-grow: 1;
    min-width: 100px;
}
.statusbar-center #statusMessage {
    width: 100%;
    text-align: left;
    border-right: none;
    overflow: hidden;
    text-overflow: ellipsis;
}
.statusbar-right { }
#languageDisplay {
    cursor: default;
}
#cursorPosition {
    border-right: none;
}
#languageSelectStatus {
     border-right: 1px solid var(--border-color);
}

button { background-color: var(--button-bg); color: var(--button-fg); border: 1px solid var(--border-color); padding: 4px 10px; border-radius: 3px; cursor: pointer; font-weight: normal; transition: background-color 0.1s, border-color 0.1s; font-size: 0.85rem; line-height: 1.2; }
button:hover { background-color: var(--button-hover-bg); }
button:active { background-color: var(--button-active-bg); }
button:disabled { background-color: var(--button-bg) !important; border-color: var(--border-color) !important; color: #888 !important; cursor: not-allowed; opacity: 0.6; }
body.theme-light button:disabled { color: #aaa !important; }
.toolbar button { padding: 3px 6px; }
.toolbar button.primary { background-color: #4a90e2; color: white; border-color: #4a90e2; }
.toolbar button.secondary { background-color: #6c757d; color: white; border-color: #6c757d; }
.toolbar button.danger { background-color: #dc3545; color: white; border-color: #dc3545; }
.toolbar button.primary:hover { background-color: #357abd; }
.toolbar button.secondary:hover { background-color: #5a6268; }
.toolbar button.danger:hover { background-color: #c82333; }
body.theme-light .toolbar button.primary { background-color: #007bff; }
body.theme-light .toolbar button.secondary { background-color: #6c757d; }
body.theme-light .toolbar button.danger { background-color: #dc3545; }
body.theme-light .toolbar button.primary:hover { background-color: #0056b3; }
body.theme-light .toolbar button.secondary:hover { background-color: #545b62; }
body.theme-light .toolbar button.danger:hover { background-color: #bd2130; }
.find-replace-container input[type="text"] { flex: 1; padding: 4px 6px; font-size: 0.85rem; min-width: 120px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--app-fg); border-radius: 2px; }
.find-replace-container input[type="text"]:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 1px var(--input-focus-border); }
.search-actions { display: flex; gap: 4px; }
.search-actions button { padding: 3px 8px; font-size: 0.8rem; }
#closeFindBtn { margin-left: 5px; padding: 2px 6px; font-size: 1rem; line-height: 1; background-color: transparent; border: none; color: var(--app-fg); opacity: 0.7; }
#closeFindBtn:hover { background-color: var(--danger-color); color: white; opacity: 1; }
.CodeMirror-lint-marker-error, .CodeMirror-lint-marker-warning { background-position: left bottom; background-repeat: repeat-x; }
.CodeMirror-lint-marker-error { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAABJJREFUCB1j8DNk+M8wrrVfJQARAADO8SKkAX27wQAAAABJRU5ErkJggg=="); }
.CodeMirror-lint-marker-warning { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAABRJREFUCB1j8Mvg/p+B6f8zVBEBAB59Ek9VRGuSAAAAAElFTkSuQmCC"); }
.CodeMirror-lint-tooltip { background-color: var(--toolbar-bg) !important; border: 1px solid var(--border-color) !important; color: var(--app-fg) !important; padding: 5px 8px !important; border-radius: 3px !important; font-size: 0.85em !important; z-index: 15 !important; box-shadow: 1px 1px 4px rgba(0,0,0,0.2); }
.cm-ai-suggestion { color: #888; font-style: italic; background-color: rgba(128, 128, 128, 0.1); }
.modal { position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background-color: var(--modal-bg); color: var(--app-fg); padding: 0; border-radius: 4px; width: 450px; max-width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid var(--border-color); overflow: hidden; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--modal-header-bg); }
.modal-header h3 { margin: 0; font-size: 1.1rem; font-weight: 600; }
.modal-close { color: var(--app-fg); font-size: 22px; font-weight: bold; cursor: pointer; line-height: 1; padding: 0 5px; opacity: 0.7; transition: opacity 0.15s; }
.modal-close:hover, .modal-close:focus { opacity: 1; text-decoration: none; outline: none; }
.modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; } /* Added max-height and scroll */
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; }
input[type="text"], input[type="number"], select { box-sizing: border-box; width: 100%; padding: 8px 10px; border-radius: 3px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--app-fg); font-size: 0.95em; }
input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 1px var(--input-focus-border); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; padding: 12px 15px; border-top: 1px solid var(--border-color); background-color: var(--modal-header-bg); }
.modal-actions button { font-weight: 500; }
.modal-actions button.primary { background-color: var(--input-focus-border); color: white; border-color: var(--input-focus-border); }
body.theme-light .modal-actions button.primary { color: white; }
.modal-actions button.primary:hover { background-color: darken(var(--input-focus-border), 10%); border-color: darken(var(--input-focus-border), 10%); }

/* --- Settings Modal Specific --- */
#settingsModal .modal-body h4 {
    margin-top: 15px;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
    font-size: 1rem;
    font-weight: 600;
}
#settingsModal .modal-body h4:first-of-type {
    margin-top: 0;
}

</style>
</head>
<body class="theme-dark">

<div class="app-container">

<!-- Menu Bar -->
<div class="menu-bar">
<ul class="menu">
<li class="menu-item">
File
<ul class="submenu">
<li class="submenu-item" id="menu-new">New File<kbd>Ctrl+N</kbd></li>
<li class="submenu-item" id="menu-open">Open File...<kbd>Ctrl+O</kbd></li>
<li class="menu-separator"></li>
<li class="submenu-item" id="menu-save" data-enabled="false">Save<kbd>Ctrl+S</kbd></li>
<li class="submenu-item" id="menu-saveas" data-enabled="false">Save As...<kbd>Ctrl+Shift+S</kbd></li>
<li class="menu-separator"></li>
<li class="submenu-item" id="menu-closefile" data-enabled="false">Close File<kbd>Ctrl+W</kbd></li>
</ul>
</li>
<li class="menu-item">
Edit
<ul class="submenu">
<li class="submenu-item" id="menu-undo" data-enabled="false">Undo<kbd>Ctrl+Z</kbd></li>
<li class="submenu-item" id="menu-redo" data-enabled="false">Redo<kbd>Ctrl+Y</kbd></li>
<li class="menu-separator"></li>
<li class="submenu-item" id="menu-find">Find/Replace...<kbd>Ctrl+F</kbd></li>
<li class="menu-separator"></li>
<li class="submenu-item" id="menu-ai-complete">AI Complete<kbd>Alt+\</kbd></li>
<li class="menu-separator"></li>
<li class="submenu-item" id="menu-preferences">Preferences...</li>
</ul>
</li>
<li class="menu-item">
View
<ul class="submenu">
<li class="menu-item">
Language ▶
<ul class="submenu language-submenu">
<!-- Populated by JS -->
</ul>
</li>
<li class="submenu-item" id="menu-toggle-linenumbers">Toggle Line Numbers</li>
<li class="submenu-item" id="menu-toggle-wrapping">Toggle Line Wrapping</li>
</ul>
</li>
<li class="menu-item">
Theme
<ul class="submenu" id="theme-menu">
<!-- Populated by JS -->
</ul>
</li>
</ul>
</div>

<!-- Toolbar -->
<div class="toolbar">
<button id="toolbar-new" title="New File (Ctrl+N)">New</button>
<button id="toolbar-open" title="Open File (Ctrl+O)">Open</button>
<button id="toolbar-save" title="Save (Ctrl+S)" disabled>Save</button>
<button id="toolbar-find" class="secondary" title="Find & Replace (Ctrl+F)">Find</button>
</div>

<!-- Find/Replace Bar -->
<div class="find-replace-container" id="findReplaceContainer">
<input type="text" id="findInput" placeholder="Find...">
<input type="text" id="replaceInput" placeholder="Replace with...">
<div class="search-actions">
<button id="findPrevBtn" class="secondary" title="Find Previous (Shift+Enter)">Prev</button>
<button id="findNextBtn" class="secondary" title="Find Next (Enter)">Next</button>
<button id="replaceBtn" class="secondary" title="Replace Current">Replace</button>
<button id="replaceAllBtn" class="secondary" title="Replace All">Replace All</button>
</div>
<button id="closeFindBtn" title="Close (Esc)">&times;</button>
</div>

<!-- Editor Area -->
<div class="editor-container">
<div class="sidebar">
<h4>Files</h4>
<ul class="file-list" id="fileList"></ul>
</div>
<div class="main-content">
<div id="editor"></div>
</div>
</div>

<!-- Status Bar -->
<div class="status-bar">
    <div class="statusbar-section statusbar-left">
        <div id="fileInfo">No file opened</div>
    </div>
    <div class="statusbar-section statusbar-center">
        <div id="statusMessage">Ready</div>
    </div>
    <div class="statusbar-section statusbar-right">
        <div id="languageSelectStatus" title="Change Language (View > Language)">
            <span id="languageDisplay">Plain Text</span>
            <select id="languageSelect" style="display: none;">
                 <option value="javascript">JavaScript</option>
                 <option value="typescript">TypeScript</option>
                 <option value="htmlmixed">HTML</option>
                 <option value="css">CSS</option>
                 <option value="python">Python</option>
                 <option value="java">Java</option>
                 <option value="text/x-c++src">C++</option>
                 <option value="text/x-csharp">C#</option>
                 <option value="php">PHP</option>
                 <option value="ruby">Ruby</option>
                 <option value="go">Go</option>
                 <option value="swift">Swift</option>
                 <option value="rust">Rust</option>
                 <option value="kotlin">Kotlin</option>
                 <option value="scala">Scala</option>
                 <option value="sql">SQL</option>
                 <option value="shell">Shell Script</option>
                 <option value="perl">Perl</option>
                 <option value="r">R</option>
                 <option value="lua">Lua</option>
                 <option value="markdown">Markdown</option>
                 <option value="yaml">YAML</option>
                 <option value="xml">XML</option>
                 <option value="text/plain">Plain Text</option>
            </select>
        </div>
        <div id="cursorPosition">Ln 1, Col 1</div>
    </div>
</div>

</div> <!-- End app-container -->

<!-- Modals -->
<!-- New File Modal -->
<div id="newFileModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>Create New File</h3>
<span class="modal-close" id="closeNewFileModal" title="Close">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="newFileName">File Name:</label>
<input type="text" id="newFileName" placeholder="e.g., script.js, main.py">
</div>
<div class="form-group">
<label for="newFileLanguage">Language:</label>
<select id="newFileLanguage">
<option value="javascript">JavaScript (.js)</option>
<option value="typescript">TypeScript (.ts)</option>
<option value="htmlmixed">HTML (.html)</option>
<option value="css">CSS (.css)</option>
<option value="python">Python (.py)</option>
<option value="java">Java (.java)</option>
<option value="text/x-c++src">C++ (.cpp)</option>
<option value="text/x-csharp">C# (.cs)</option>
<option value="php">PHP (.php)</option>
<option value="ruby">Ruby (.rb)</option>
<option value="go">Go (.go)</option>
<option value="swift">Swift (.swift)</option>
<option value="rust">Rust (.rs)</option>
<option value="kotlin">Kotlin (.kt)</option>
<option value="scala">Scala (.scala)</option>
<option value="sql">SQL (.sql)</option>
<option value="shell">Shell Script (.sh)</option>
<option value="perl">Perl (.pl)</option>
<option value="r">R (.r)</option>
<option value="lua">Lua (.lua)</option>
<option value="markdown">Markdown (.md)</option>
<option value="yaml">YAML (.yaml, .yml)</option>
<option value="xml">XML (.xml)</option>
<option value="text/plain">Plain Text (.txt)</option>
</select>
</div>
</div>
<div class="modal-actions">
<button id="cancelNewFile" class="secondary">Cancel</button>
<button id="createNewFile" class="primary">Create</button>
</div>
</div>
</div>

<!-- Save As Modal -->
<div id="saveAsModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>Save File As</h3>
<span class="modal-close" id="closeSaveAsModal" title="Close">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="saveAsFileName">File Name:</label>
<input type="text" id="saveAsFileName" placeholder="example.js">
</div>
</div>
<div class="modal-actions">
<button id="cancelSaveAs" class="secondary">Cancel</button>
<button id="confirmSaveAs" class="primary">Save</button>
</div>
</div>
</div>

<!-- Settings Modal (Updated with LLM settings) -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Settings</h3>
            <span class="modal-close" id="closeSettingsModal" title="Close">&times;</span>
        </div>
        <div class="modal-body">
            <h4>Editor</h4>
            <div class="form-group">
                <label for="settingFontSize">Font Size (px):</label>
                <input type="number" id="settingFontSize" min="8" max="30" step="1">
            </div>
            <div class="form-group">
                <label for="settingTabSize">Tab Size:</label>
                <input type="number" id="settingTabSize" min="1" max="8" step="1">
            </div>
            <div class="form-group">
                <label for="settingIndentType">Indent Using:</label>
                <select id="settingIndentType">
                    <option value="spaces">Spaces</option>
                    <option value="tabs">Tabs</option>
                </select>
            </div>

            <h4>AI Completion</h4>
             <div class="form-group">
                <label for="settingApiUrl">Llama API URL:</label>
                <input type="text" id="settingApiUrl" placeholder="http://localhost:8080/completion">
            </div>
            <!-- NEW LLM Settings -->
            <div class="form-group">
                <label for="settingAiTemp">Temperature (0-2, e.g., 0.7):</label>
                <input type="number" id="settingAiTemp" min="0" max="2" step="0.1">
            </div>
            <div class="form-group">
                <label for="settingAiTopK">Top-K (0 for disabled, e.g., 40):</label>
                <input type="number" id="settingAiTopK" min="0" step="1">
            </div>
            <div class="form-group">
                <label for="settingAiTopP">Top-P (0-1, e.g., 0.9):</label>
                <input type="number" id="settingAiTopP" min="0" max="1" step="0.05">
            </div>
             <div class="form-group">
                <label for="settingAiMaxTokens">Max New Tokens (e.g., 128):</label>
                <input type="number" id="settingAiMaxTokens" min="1" step="1">
            </div>
            <!-- End NEW LLM Settings -->

        </div>
        <div class="modal-actions">
            <button id="cancelSettings" class="secondary">Cancel</button>
            <button id="saveSettings" class="primary">Save Settings</button>
        </div>
    </div>
</div>

<script>
// Make linters available globally for CodeMirror addons BEFORE the IIFE
window.JSHINT = JSHINT;
window.CSSLint = CSSLint;
window.HTMLHint = HTMLHint;
window.jsyaml = jsyaml; // Make js-yaml available

(function() { // Start IIFE to encapsulate the editor logic
    'use strict'; // Enable strict mode

    // --- Constants ---
    const DEFAULT_API_URL = 'http://localhost:8080/completion';
    // Defaults for new AI settings
    const DEFAULT_AI_TEMP = 0.7;
    const DEFAULT_AI_TOP_K = 40;
    const DEFAULT_AI_TOP_P = 0.9;
    const DEFAULT_AI_MAX_TOKENS = 128;
    // --- Other constants remain the same ---
    const AI_COMPLETION_STOP_TOKENS = ["\n", "\t", ";", "}", ")", "<|EOT|>", "```"];
    const AI_PROMPT_MAX_CHARS = 2048;
    const STATUS_MESSAGE_DEFAULT = "Ready";
    const STATUS_MESSAGE_DURATION = 3000;
    const MODAL_FOCUS_DELAY = 50;
    const LINTABLE_MODES = ['javascript', 'typescript', 'json', 'css', 'htmlmixed', 'yaml'];
    const DEFAULT_LANGUAGE = 'text/plain';
    const DEFAULT_THEME_NAME = "System Dark";
    const SETTINGS_STORAGE_KEY = 'lamaedit_settings';

    const APP_THEMES = {
        "System Light": { cm: "default", type: "light" },
        "System Dark": { cm: "dracula", type: "dark" },
        "Dracula": { cm: "dracula", type: "dark" },
        "Material": { cm: "material", type: "dark" },
        "Monokai": { cm: "monokai", type: "dark" },
        "Eclipse": { cm: "eclipse", type: "light" },
        "Base16 Light": { cm: "base16-light", type: "light" },
        "Solarized Light": { cm: "solarized light", type: "light" },
        "Solarized Dark": { cm: "solarized dark", type: "dark" },
    };

    // --- State Variables ---
    let files = []; // Array of file objects { name, content, language, unsaved, handle }
    let currentFileIndex = -1; // Index of the currently active file in the `files` array
    let editor; // CodeMirror instance
    let isAICompleting = false; // Flag to prevent concurrent AI requests
    let activeSuggestionMarker = null; // Reference to the current AI suggestion marker
    let isInsertingAISuggestion = false; // Flag to ignore editor changes during AI insertion
    let currentAppTheme = DEFAULT_THEME_NAME; // Current application theme name
    let statusTimeoutId = null; // Timeout ID for clearing status messages

    // MODIFIED: Add AI settings to appSettings
    let appSettings = {
        fontSize: 14,
        tabSize: 2,
        indentWithTabs: false,
        apiUrl: DEFAULT_API_URL,
        aiTemperature: DEFAULT_AI_TEMP, // NEW
        aiTopK: DEFAULT_AI_TOP_K,       // NEW
        aiTopP: DEFAULT_AI_TOP_P,       // NEW
        aiMaxTokens: DEFAULT_AI_MAX_TOKENS // NEW (replaces old constant for usage)
    };

    // --- DOM Element References (Cached) ---
    const dom = {};

    /** Caches references to frequently used DOM elements. */
    function cacheDOMElements() {
        dom.fileList = document.getElementById("fileList");
        dom.editorContainer = document.getElementById("editor");
        dom.cursorPosition = document.getElementById("cursorPosition");
        dom.fileInfo = document.getElementById("fileInfo");
        dom.languageSelect = document.getElementById("languageSelect");
        dom.languageDisplay = document.getElementById("languageDisplay");
        dom.toolbarSaveBtn = document.getElementById("toolbar-save");
        dom.findReplaceContainer = document.getElementById("findReplaceContainer");
        dom.findInput = document.getElementById("findInput");
        dom.replaceInput = document.getElementById("replaceInput");
        dom.newFileModal = document.getElementById("newFileModal");
        dom.saveAsModal = document.getElementById("saveAsModal");
        dom.newFileNameInput = document.getElementById("newFileName");
        dom.newFileLangSelect = document.getElementById("newFileLanguage");
        dom.saveAsFileNameInput = document.getElementById("saveAsFileName");
        dom.statusMessage = document.getElementById("statusMessage");
        dom.languageSubmenu = document.querySelector('.language-submenu');
        dom.themeMenu = document.getElementById('theme-menu');
        dom.menuSave = document.getElementById('menu-save');
        dom.menuSaveAs = document.getElementById('menu-saveas');
        dom.menuCloseFile = document.getElementById('menu-closefile');
        dom.menuUndo = document.getElementById('menu-undo');
        dom.menuRedo = document.getElementById('menu-redo');
        dom.settingsModal = document.getElementById('settingsModal');
        dom.settingFontSize = document.getElementById('settingFontSize');
        dom.settingTabSize = document.getElementById('settingTabSize');
        dom.settingIndentType = document.getElementById('settingIndentType');
        dom.settingApiUrl = document.getElementById('settingApiUrl');

        // NEW: Cache new AI setting inputs
        dom.settingAiTemp = document.getElementById('settingAiTemp');
        dom.settingAiTopK = document.getElementById('settingAiTopK');
        dom.settingAiTopP = document.getElementById('settingAiTopP');
        dom.settingAiMaxTokens = document.getElementById('settingAiMaxTokens');
    }

    // --- Initialization ---

     /** Loads settings from localStorage or uses defaults. */
    function loadSettings() {
        const storedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
        // MODIFIED: Include new AI defaults
        const defaultSettings = {
            fontSize: 14,
            tabSize: 2,
            indentWithTabs: false,
            apiUrl: DEFAULT_API_URL,
            aiTemperature: DEFAULT_AI_TEMP,
            aiTopK: DEFAULT_AI_TOP_K,
            aiTopP: DEFAULT_AI_TOP_P,
            aiMaxTokens: DEFAULT_AI_MAX_TOKENS
        };

        if (storedSettings) {
            try {
                const parsedSettings = JSON.parse(storedSettings);
                appSettings = { ...defaultSettings, ...parsedSettings }; // Merge handles missing keys
                console.log("Loaded settings from localStorage:", appSettings);
            } catch (e) {
                console.error("Error parsing settings from localStorage, using defaults.", e);
                appSettings = defaultSettings;
            }
        } else {
            appSettings = defaultSettings;
            console.log("No stored settings found, using defaults.");
        }
        // Add fallbacks just in case loading resulted in undefined/wrong types
        appSettings.apiUrl = appSettings.apiUrl || DEFAULT_API_URL;
        appSettings.aiTemperature = typeof appSettings.aiTemperature === 'number' ? appSettings.aiTemperature : DEFAULT_AI_TEMP;
        appSettings.aiTopK = typeof appSettings.aiTopK === 'number' ? appSettings.aiTopK : DEFAULT_AI_TOP_K;
        appSettings.aiTopP = typeof appSettings.aiTopP === 'number' ? appSettings.aiTopP : DEFAULT_AI_TOP_P;
        appSettings.aiMaxTokens = typeof appSettings.aiMaxTokens === 'number' && appSettings.aiMaxTokens > 0 ? appSettings.aiMaxTokens : DEFAULT_AI_MAX_TOKENS;
    }

    /** Initializes the CodeMirror editor instance. */
    function initEditor() {
        const initialTheme = APP_THEMES[currentAppTheme];
        editor = CodeMirror(dom.editorContainer, {
            // Apply initial settings from appSettings here
            mode: DEFAULT_LANGUAGE,
            theme: initialTheme.cm,
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            indentUnit: appSettings.tabSize, // Use setting
            tabSize: appSettings.tabSize,     // Use setting
            indentWithTabs: appSettings.indentWithTabs, // Use setting
            lineWrapping: false,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"],
            lint: false, // Enable per file based on language
            readOnly: true, // Start read-only until a file is opened
            extraKeys: {
                "Ctrl-Space": "autocomplete",
                "Ctrl-F": () => handleFindMenuClick(),
                "Cmd-F": () => handleFindMenuClick(),
                "Ctrl-H": "replace", // Default CM replace binding
                "Cmd-Option-F": "replace", // Default CM replace binding (Mac)
                "Esc": handleEscapeKey,
                "Alt-\\": handleAICompleteMenuClick,
                "Tab": handleTabKey,
                "Ctrl-S": handleSaveClick,
                "Cmd-S": handleSaveClick,
                "Ctrl-Shift-S": handleSaveAsClick,
                "Cmd-Shift-S": handleSaveAsClick,
                "Ctrl-O": handleOpenFileClick,
                "Cmd-O": handleOpenFileClick,
                "Ctrl-N": handleNewFileClick,
                "Cmd-N": handleNewFileClick,
                "Ctrl-W": handleCloseFileClick,
                "Cmd-W": handleCloseFileClick,
                "Ctrl-Z": () => editor.undo(),
                "Cmd-Z": () => editor.undo(),
                "Ctrl-Y": () => editor.redo(), // Windows/Linux Redo
                "Cmd-Y": () => editor.redo(), // Non-standard Mac Redo (often Shift+Cmd+Z)
                "Shift-Cmd-Z": () => editor.redo(), // Standard Mac Redo
            }
        });

         // Apply font size after editor creation
        applyEditorFontSize(appSettings.fontSize);

        editor.on("cursorActivity", handleCursorActivity);
        editor.on("change", handleEditorChange);
        editor.on("changes", updateUndoRedoState); // Update undo/redo state on any change batches
    }

    /** Initializes the application: caches DOM, sets up editor, themes, menus, listeners. */
    function initApp() {
        cacheDOMElements();
        loadSettings(); // Load settings BEFORE initializing editor
        initEditor();   // Editor uses loaded settings
        applyAppTheme(currentAppTheme); // Apply initial theme to body/UI
        populateLanguageMenu();
        populateThemeMenu();
        setupEventListeners();
        updateUIForFileStatus(); // Initial UI state (no file open)
        setStatusMessage(STATUS_MESSAGE_DEFAULT);
    }

    // --- Settings Logic ---

    /** Saves current appSettings to localStorage. */
    function persistSettings() {
        try {
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(appSettings));
            console.log("Saved settings to localStorage:", appSettings);
        } catch (e) {
            console.error("Error saving settings to localStorage:", e);
            setStatusMessage("Failed to save settings", true, STATUS_MESSAGE_DURATION);
        }
    }

    /** Applies the font size setting to the CodeMirror editor. */
    function applyEditorFontSize(size) {
        if (editor && size >= 8 && size <= 30) {
             const wrapper = editor.getWrapperElement();
             if (wrapper) {
                wrapper.style.fontSize = size + 'px';
                editor.refresh(); // Important: Refresh CM to recalculate layout
             }
        }
    }

    /** Applies all current appSettings to the editor and potentially other parts. */
    function applySettings() {
        if (!editor) return;

        editor.operation(() => { // Group CM changes
            editor.setOption('tabSize', appSettings.tabSize);
            editor.setOption('indentUnit', appSettings.tabSize); // Keep indentUnit same as tabSize usually
            editor.setOption('indentWithTabs', appSettings.indentWithTabs);
        });

        applyEditorFontSize(appSettings.fontSize);

        // Note: AI parameters are read directly when needed in fetchAICompletion
        console.log("Applied editor settings.");
    }

     /** Populates the settings modal with current values. */
    function populateSettingsModal() {
        // --- (Populate editor settings) ---
        dom.settingFontSize.value = appSettings.fontSize;
        dom.settingTabSize.value = appSettings.tabSize;
        dom.settingIndentType.value = appSettings.indentWithTabs ? 'tabs' : 'spaces';
        dom.settingApiUrl.value = appSettings.apiUrl;
        // NEW: Populate AI settings
        dom.settingAiTemp.value = appSettings.aiTemperature;
        dom.settingAiTopK.value = appSettings.aiTopK;
        dom.settingAiTopP.value = appSettings.aiTopP;
        dom.settingAiMaxTokens.value = appSettings.aiMaxTokens;
    }

    /** Handles clicking the "Save Settings" button in the modal. */
    function handleSaveSettingsClick() {
        // --- (Read editor settings) ---
        const newFontSize = parseInt(dom.settingFontSize.value, 10);
        const newTabSize = parseInt(dom.settingTabSize.value, 10);
        const newIndentWithTabs = dom.settingIndentType.value === 'tabs';
        const newApiUrl = dom.settingApiUrl.value.trim();
        // NEW: Read AI settings
        const newTemp = parseFloat(dom.settingAiTemp.value);
        const newTopK = parseInt(dom.settingAiTopK.value, 10);
        const newTopP = parseFloat(dom.settingAiTopP.value);
        const newMaxTokens = parseInt(dom.settingAiMaxTokens.value, 10);


        // --- (Validation for editor settings) ---
        if (isNaN(newFontSize) || newFontSize < 8 || newFontSize > 30) { alert("Font size must be between 8 and 30."); dom.settingFontSize.focus(); return; }
        if (isNaN(newTabSize) || newTabSize < 1 || newTabSize > 8) { alert("Tab size must be between 1 and 8."); dom.settingTabSize.focus(); return; }
        if (newApiUrl && !newApiUrl.startsWith('http://') && !newApiUrl.startsWith('https://')) { alert("Please enter a valid URL (starting with http:// or https://) for the AI API."); dom.settingApiUrl.focus(); return; }

        // NEW: Validation for AI settings
        if (isNaN(newTemp) || newTemp < 0 || newTemp > 2) {
            alert("Temperature must be a number between 0 and 2.");
            dom.settingAiTemp.focus();
            return;
        }
         if (isNaN(newTopK) || newTopK < 0) {
            alert("Top-K must be a non-negative integer (0 to disable).");
            dom.settingAiTopK.focus();
            return;
        }
        if (isNaN(newTopP) || newTopP < 0 || newTopP > 1) {
            alert("Top-P must be a number between 0 and 1.");
            dom.settingAiTopP.focus();
            return;
        }
        if (isNaN(newMaxTokens) || newMaxTokens < 1) {
            alert("Max New Tokens must be a positive integer.");
            dom.settingAiMaxTokens.focus();
            return;
        }


        // --- (Update appSettings with editor values) ---
        appSettings.fontSize = newFontSize;
        appSettings.tabSize = newTabSize;
        appSettings.indentWithTabs = newIndentWithTabs;
        appSettings.apiUrl = newApiUrl || DEFAULT_API_URL;
        // NEW: Update appSettings with AI values
        appSettings.aiTemperature = newTemp;
        appSettings.aiTopK = newTopK;
        appSettings.aiTopP = newTopP;
        appSettings.aiMaxTokens = newMaxTokens;


        applySettings(); // Apply editor settings
        persistSettings(); // Save all settings

        closeModal(dom.settingsModal);
        setStatusMessage("Settings saved successfully", false, STATUS_MESSAGE_DURATION);
    }


    // --- Helper Functions ---

    /** Sets the status bar message. */
    function setStatusMessage(message = STATUS_MESSAGE_DEFAULT, isError = false, duration = 0) {
        if (statusTimeoutId) { clearTimeout(statusTimeoutId); statusTimeoutId = null; }
        if (!dom.statusMessage) return;
        dom.statusMessage.textContent = message;
        dom.statusMessage.style.color = isError ? "var(--danger-color)" : "var(--app-fg)";
        dom.statusMessage.style.fontWeight = isError ? "bold" : "normal";
        dom.statusMessage.title = message;
        if (duration > 0) {
            statusTimeoutId = setTimeout(() => {
                if (dom.statusMessage.textContent === message) { setStatusMessage(STATUS_MESSAGE_DEFAULT); }
                statusTimeoutId = null;
            }, duration);
        }
    }

    /** Enables or disables a menu item visually and functionally. */
    function setMenuItemEnabled(menuItemElement, enabled) {
        if (!menuItemElement) return;
        menuItemElement.classList.toggle('disabled', !enabled);
        menuItemElement.dataset.enabled = enabled ? 'true' : 'false';
    }

    /** Opens a modal dialog. */
    function openModal(modalElement) {
        if (!modalElement) return;
        clearActiveSuggestion(false);
        modalElement.classList.add('active');
        const firstInput = modalElement.querySelector('.modal-body input[type="text"], .modal-body input[type="number"], .modal-body select');
        if (firstInput) {
            setTimeout(() => {
                firstInput.focus();
                if (firstInput.select && typeof firstInput.select === 'function') { try { firstInput.select(); } catch (e) { /* Ignore */ } }
            }, MODAL_FOCUS_DELAY);
        }
    }

    /** Closes a modal dialog. */
    function closeModal(modalElement) {
        if (!modalElement) return;
        modalElement.classList.remove('active');
        if (editor) editor.focus();
    }

    // --- UI Update Functions ---

    /** Updates the cursor position display in the status bar. */
    function handleCursorActivity() {
        if (!editor || !dom.cursorPosition) return;
        const cursor = editor.getCursor();
        dom.cursorPosition.textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;
        if (activeSuggestionMarker) {
            const markerRange = activeSuggestionMarker.find();
            if (markerRange) {
                const currentCursor = editor.getCursor();
                if (CodeMirror.cmpPos(currentCursor, markerRange.from) < 0 || CodeMirror.cmpPos(currentCursor, markerRange.to) > 0) { clearActiveSuggestion(false); }
            } else { clearActiveSuggestion(false); }
        }
    }

    /** Handles changes in the editor content, marks file as unsaved. */
    function handleEditorChange(cm, change) {
        if (isInsertingAISuggestion) return;
        if (activeSuggestionMarker) clearActiveSuggestion(false);
        if (currentFileIndex >= 0 && files[currentFileIndex] && !files[currentFileIndex].unsaved) {
            if (change.origin && !['setValue', '*lint*', '+AIClear', '+AICompletion'].includes(change.origin)) {
                files[currentFileIndex].unsaved = true;
                updateFileList();
                updateFileInfo();
                updateSaveButtonState();
            }
        }
    }

    /** Updates the enabled state of Undo/Redo menu items. */
    function updateUndoRedoState() {
        if (!editor || !dom.menuUndo || !dom.menuRedo) return;
        const history = editor.historySize();
        setMenuItemEnabled(dom.menuUndo, history.undo > 0);
        setMenuItemEnabled(dom.menuRedo, history.redo > 0);
    }

    /** Rerenders the file list in the sidebar. */
    function updateFileList() {
        if (!dom.fileList) return;
        dom.fileList.innerHTML = "";
        if (files.length === 0) {
            const li = document.createElement("li"); li.textContent = "No files open"; li.style.cssText = "padding: 10px; color: var(--app-fg); opacity: 0.6; font-size: 0.85rem; text-align: center;"; dom.fileList.appendChild(li); return;
        }
        files.forEach((file, index) => {
            const li = document.createElement("li"); li.className = `file-item ${index === currentFileIndex ? "active" : ""}`; li.title = file.name; li.dataset.index = index; li.onclick = () => openFileByIndex(index);
            const nameSpan = document.createElement("span"); nameSpan.className = "file-name"; nameSpan.textContent = file.name;
            if (file.unsaved) { const unsavedIndicator = document.createElement("span"); unsavedIndicator.className = "unsaved-indicator"; unsavedIndicator.textContent = " *"; unsavedIndicator.title = "Unsaved changes"; nameSpan.appendChild(unsavedIndicator); }
            const removeBtn = document.createElement("button"); removeBtn.className = "file-remove"; removeBtn.innerHTML = "&times;"; removeBtn.title = `Close ${file.name}`; removeBtn.dataset.index = index; removeBtn.onclick = (e) => { e.stopPropagation(); removeFile(index); };
            li.appendChild(nameSpan); li.appendChild(removeBtn); dom.fileList.appendChild(li);
        });
    }

    /** Updates the file name and language display in the status bar. */
    function updateFileInfo() {
        if (!dom.fileInfo || !dom.languageDisplay || !dom.languageSelect) return;
        if (currentFileIndex >= 0 && files[currentFileIndex]) {
            const file = files[currentFileIndex];
            dom.fileInfo.textContent = `${file.name}${file.unsaved ? "*" : ""}`;
            const langOption = dom.languageSelect.querySelector(`option[value="${file.language}"]`);
            const langDisplayText = langOption ? langOption.text : file.language;
            dom.languageDisplay.textContent = langDisplayText;
        } else {
            dom.fileInfo.textContent = "No file opened";
            dom.languageDisplay.textContent = "Plain Text";
            if (dom.cursorPosition) dom.cursorPosition.textContent = `Ln 1, Col 1`;
        }
    }


    /** Updates the enabled state of Save/Save As buttons and menu items. */
    function updateSaveButtonState() {
         if (!dom.toolbarSaveBtn || !dom.menuSave || !dom.menuSaveAs || !dom.menuCloseFile) return;
        const hasActiveFile = currentFileIndex >= 0 && files[currentFileIndex];
        const isUnsaved = hasActiveFile && files[currentFileIndex].unsaved;
        dom.toolbarSaveBtn.disabled = !isUnsaved;
        setMenuItemEnabled(dom.menuSave, isUnsaved);
        setMenuItemEnabled(dom.menuSaveAs, hasActiveFile);
        setMenuItemEnabled(dom.menuCloseFile, hasActiveFile);
    }

    /** Updates all UI elements related to the current file's status. */
    function updateUIForFileStatus() {
        updateFileList();
        updateFileInfo();
        updateSaveButtonState();
        updateLanguageMenuSelection(); // Update language menu checkmark
        updateUndoRedoState(); // History changes with file content/switch
    }

    // --- File Management Logic ---

    /** Sets the active file, updating the editor content and UI. */
    function setActiveFile(index) {
        console.log(`Setting active file to index: ${index}`);
        clearActiveSuggestion(false);
        if (!editor) { console.error("Editor not initialized..."); return; }
        if (index < 0 || index >= files.length) {
            currentFileIndex = -1; editor.setValue(""); editor.clearHistory(); editor.setOption("mode", DEFAULT_LANGUAGE); editor.setOption("lint", false); editor.setOption("readOnly", true); console.log("No file active..."); updateUIForFileStatus(); return;
        }
        if (index === currentFileIndex) { console.log(`File at index ${index} is already active.`); return; }
        currentFileIndex = index; const file = files[currentFileIndex];
        editor.operation(() => { editor.setOption("readOnly", false); editor.setValue(file.content); editor.setOption("mode", file.language); editor.setOption("lint", LINTABLE_MODES.includes(file.language)); console.log(`Switched to file "${file.name}". Mode: ${file.language}, Linting: ${editor.getOption("lint")}`); });
        editor.clearHistory(); editor.focus(); updateUIForFileStatus();
    }

    /** Opens a file by its index in the `files` array. */
    function openFileByIndex(index) { setActiveFile(index); }

    /** Creates a new file object and adds it to the list. */
    function createNewFileEntry(name, language) {
        if (!name) { setStatusMessage("File name cannot be empty.", true, STATUS_MESSAGE_DURATION); alert("File name cannot be empty."); return false; }
        if (files.some(f => f.name === name)) { setStatusMessage(`File "${name}" already exists.`, true, STATUS_MESSAGE_DURATION); alert(`A file named "${name}" already exists.`); return false; }
        const newFile = { name: name, content: "", language: language, unsaved: true, handle: null };
        files.push(newFile); clearActiveSuggestion(false); setActiveFile(files.length - 1); setStatusMessage(`Created "${name}"`, false, STATUS_MESSAGE_DURATION); return true;
    }

    /** Removes a file from the list, prompting if unsaved. */
    function removeFile(index) {
        if (index < 0 || index >= files.length) return;
        const fileToRemove = files[index];
        if (fileToRemove.unsaved) { if (!window.confirm(`Discard unsaved changes in "${fileToRemove.name}"?`)) { return; } }
        const closingCurrent = (index === currentFileIndex); const closedFileName = fileToRemove.name; files.splice(index, 1);
        let nextIndex = -1; if (files.length > 0) { if (closingCurrent) { nextIndex = Math.max(0, index - 1); } else { nextIndex = (currentFileIndex > index) ? currentFileIndex - 1 : currentFileIndex; } }
        clearActiveSuggestion(false); setActiveFile(nextIndex); setStatusMessage(`Closed "${closedFileName}"`, false, STATUS_MESSAGE_DURATION);
    }

    // --- File Saving/Loading Helpers ---

    /** Gets the appropriate MIME type for a given language mode. */
    function getMimeType(language) {
        switch (language) {
            case "javascript": return "text/javascript";
            case "typescript": return "text/typescript";
            case "htmlmixed": return "text/html";
            case "css": return "text/css";
            case "xml": return "application/xml";
            case "python": return "text/x-python";
            case "java": return "text/x-java-source";
            case "text/x-c++src": return "text/x-c++src";
            case "text/x-csharp": return "text/x-csharp";
            case "php": return "application/x-httpd-php";
            case "ruby": return "text/x-ruby";
            case "go": return "text/x-go";
            case "swift": return "text/x-swift";
            case "rust": return "text/rust";
            case "kotlin": return "text/x-kotlin";
            case "scala": return "text/x-scala";
            case "sql": return "application/sql";
            case "shell": return "application/x-sh";
            case "perl": return "text/x-perl";
            case "r": return "text/x-r-source";
            case "lua": return "text/x-lua";
            case "markdown": return "text/markdown";
            case "yaml": return "application/x-yaml";
            case "json": return "application/json";
            case "text/plain": default: return "text/plain";
        }
    }

    /** Suggests a file extension based on the language mode. */
    function getSuggestedExtension(language) {
        switch (language) {
            case "javascript": return ".js";
            case "typescript": return ".ts";
            case "htmlmixed": return ".html";
            case "css": return ".css";
            case "xml": return ".xml";
            case "python": return ".py";
            case "java": return ".java";
            case "text/x-c++src": return ".cpp";
            case "text/x-csharp": return ".cs";
            case "php": return ".php";
            case "ruby": return ".rb";
            case "go": return ".go";
            case "swift": return ".swift";
            case "rust": return ".rs";
            case "kotlin": return ".kt";
            case "scala": return ".scala";
            case "sql": return ".sql";
            case "shell": return ".sh";
            case "perl": return ".pl";
            case "r": return ".r";
            case "lua": return ".lua";
            case "markdown": return ".md";
            case "yaml": return ".yaml";
            case "json": return ".json";
            case "text/plain": default: return ".txt";
        }
    }

    /** Determines the language mode from a file name extension. */
    function getLanguageFromFileName(name) {
        if (!name || name.indexOf('.') === -1) return DEFAULT_LANGUAGE;
        const extension = name.split('.').pop().toLowerCase();
        switch (extension) {
            case "js": case "mjs": case "cjs": return "javascript";
            case "ts": case "tsx": return "typescript";
            case "html": case "htm": return "htmlmixed";
            case "css": return "css";
            case "xml": case "svg": case "rss": case "atom": return "xml";
            case "py": case "pyw": return "python";
            case "java": return "java";
            case "c": case "h": return "text/x-csrc";
            case "cpp": case "cxx": case "hpp": case "hxx": return "text/x-c++src";
            case "cs": return "text/x-csharp";
            case "php": case "php3": case "php4": case "php5": case "phtml": return "php";
            case "rb": return "ruby";
            case "go": return "go";
            case "swift": return "swift";
            case "rs": return "rust";
            case "kt": case "kts": return "kotlin";
            case "scala": return "scala";
            case "sql": return "sql";
            case "sh": case "bash": case "zsh": return "shell";
            case "pl": case "pm": return "perl";
            case "r": return "r";
            case "lua": return "lua";
            case "md": case "markdown": return "markdown";
            case "yaml": case "yml": return "yaml";
            case "json": return "application/json";
            case "txt": default: return DEFAULT_LANGUAGE;
        }
    }

    /** Generates the 'types' array for the File System Access API file pickers. */
    function getFilePickerTypes() {
        return [
            { description: 'JavaScript', accept: { 'text/javascript': ['.js', '.mjs', '.cjs'] } },
            { description: 'TypeScript', accept: { 'text/typescript': ['.ts', '.tsx'] } },
            { description: 'HTML', accept: { 'text/html': ['.html', '.htm'] } },
            { description: 'CSS', accept: { 'text/css': ['.css'] } },
            { description: 'Python', accept: { 'text/x-python': ['.py', '.pyw'] } },
            { description: 'Java', accept: { 'text/x-java-source': ['.java'] } },
            { description: 'C/C++', accept: { 'text/x-csrc': ['.c', '.h'], 'text/x-c++src': ['.cpp', '.cxx', '.hpp', '.hxx'] } },
            { description: 'C#', accept: { 'text/x-csharp': ['.cs'] } },
            { description: 'PHP', accept: { 'application/x-httpd-php': ['.php', '.phtml'] } },
            { description: 'Ruby', accept: { 'text/x-ruby': ['.rb'] } },
            { description: 'Go', accept: { 'text/x-go': ['.go'] } },
            { description: 'Swift', accept: { 'text/x-swift': ['.swift'] } },
            { description: 'Rust', accept: { 'text/rust': ['.rs'] } },
            { description: 'Kotlin', accept: { 'text/x-kotlin': ['.kt', '.kts'] } },
            { description: 'Scala', accept: { 'text/x-scala': ['.scala'] } },
            { description: 'SQL', accept: { 'application/sql': ['.sql'] } },
            { description: 'Shell Script', accept: { 'application/x-sh': ['.sh', '.bash', '.zsh'] } },
            { description: 'Perl', accept: { 'text/x-perl': ['.pl', '.pm'] } },
            { description: 'R Script', accept: { 'text/x-r-source': ['.r'] } },
            { description: 'Lua', accept: { 'text/x-lua': ['.lua'] } },
            { description: 'Markdown', accept: { 'text/markdown': ['.md', '.markdown'] } },
            { description: 'YAML', accept: { 'application/x-yaml': ['.yaml', '.yml'] } },
            { description: 'XML', accept: { 'application/xml': ['.xml', '.svg', '.rss', '.atom'] } },
            { description: 'JSON', accept: { 'application/json': ['.json'] } },
            { description: 'Text Files', accept: { 'text/plain': ['.txt'] } },
            { description: 'All Files', accept: {'*/*': []} }
        ];
    }

    /** Triggers a file download as a fallback mechanism. */
    function triggerDownload(filename, content, language) {
        const blob = new Blob([content], { type: getMimeType(language) });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log(`Download initiated for "${filename}".`);
    }


    // --- File Saving/Loading (Core Logic) ---

    /** Saves the current file, handling 'Save As' logic and FSA API/fallback. */
    async function saveFile(isSaveAs = false) {
        clearActiveSuggestion(false);
        if (!editor) return;

        if (currentFileIndex < 0 || !files[currentFileIndex]) {
            console.error("Save attempt failed: No active file.");
            setStatusMessage("No active file to save", true, STATUS_MESSAGE_DURATION);
            return;
        }

        const file = files[currentFileIndex];
        file.content = editor.getValue();

        let currentHandle = file.handle;
        let suggestedName = file.name;
        let targetLanguage = file.language;

        if (isSaveAs) {
            suggestedName = dom.saveAsFileNameInput.value.trim();
            if (!suggestedName) {
                alert("Please enter a file name.");
                dom.saveAsFileNameInput.focus();
                return; // Keep Save As modal open
            }
            targetLanguage = getLanguageFromFileName(suggestedName);
        } else if (!file.name) {
            console.log("Save clicked on new file, redirecting to Save As flow.");
            handleSaveAsClick();
            return;
        }

        setStatusMessage(`Saving "${suggestedName}"...`);

        try {
            let fileHandleToUse;
            if (window.showSaveFilePicker) {
                 const pickerOptions = { suggestedName: suggestedName, types: getFilePickerTypes() };
                 if (isSaveAs || !currentHandle) {
                    fileHandleToUse = await window.showSaveFilePicker(pickerOptions);
                    file.handle = fileHandleToUse;
                    file.name = fileHandleToUse.name;
                    targetLanguage = getLanguageFromFileName(file.name);
                 } else {
                    fileHandleToUse = currentHandle;
                 }
                 const writable = await fileHandleToUse.createWritable();
                 await writable.write(file.content);
                 await writable.close();
                 console.log(`File "${file.name}" saved successfully via FSA API.`);
            } else {
                console.log("FSA API not supported. Using download fallback.");
                if (isSaveAs) { file.name = suggestedName; }
                triggerDownload(file.name, file.content, targetLanguage);
            }

            file.language = targetLanguage;
            file.unsaved = false;
            setFileLanguage(file.language, true);
            setStatusMessage(`Saved ${file.name}`, false, STATUS_MESSAGE_DURATION);
            if (isSaveAs) closeModal(dom.saveAsModal);

        } catch (err) {
            if (err.name === 'AbortError') {
                console.log("Save operation cancelled by user.");
                setStatusMessage("Save cancelled", false, STATUS_MESSAGE_DURATION);
                if (isSaveAs) closeModal(dom.saveAsModal);
                return;
            }
            console.error("Error saving file:", err);
            setStatusMessage(`Save failed: ${err.message}`, true, 5000);
             if (isSaveAs) closeModal(dom.saveAsModal);
        } finally {
            updateUIForFileStatus();
        }
    }

    /** Opens a file using FSA API or fallback input element. */
    async function openFile() {
        console.log("Attempting to open file...");
        clearActiveSuggestion(false);
        try {
            let fileHandle; let fileData;
            if (window.showOpenFilePicker) {
                console.log("Using showOpenFilePicker API.");
                [fileHandle] = await window.showOpenFilePicker({ types: getFilePickerTypes(), multiple: false });
                fileData = await fileHandle.getFile();
                console.log(`File selected via FSA: "${fileData.name}"`);
            } else {
                console.log("Using legacy <input type='file'> fallback.");
                fileData = await triggerLegacyFileOpen();
                fileHandle = null;
                if (!fileData) return;
                 console.log(`File selected via legacy input: "${fileData.name}"`);
            }
            await handleFileOpenResult(fileData, fileHandle);
        } catch (err) {
            if (err.name === 'AbortError') {
                console.log("Open file operation cancelled by user.");
                setStatusMessage("Open cancelled", false, STATUS_MESSAGE_DURATION);
            } else {
                console.error("Error opening file:", err);
                setStatusMessage(`Open failed: ${err.message}`, true, 5000);
            }
        }
    }

    /** Reads file content using FileReader (for legacy open). */
    function readFileContentLegacy(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => resolve(event.target.result);
            reader.onerror = (error) => { console.error("FileReader error:", error); reject(new Error(`Error reading file "${file.name}"`)); };
            reader.readAsText(file);
        });
    }

    /** Prompts the user to select a file using the legacy input method. */
     function triggerLegacyFileOpen() {
        return new Promise((resolve, reject) => {
             const input = document.createElement("input"); input.type = "file";
             const allExtensions = getFilePickerTypes().flatMap(type => Object.values(type.accept || {}).flat()).filter((ext, index, self) => ext && self.indexOf(ext) === index);
             input.accept = allExtensions.join(',') || "*/*";
             input.onchange = (e) => { if (e.target.files && e.target.files.length > 0) { resolve(e.target.files[0]); } else { resolve(null); } document.body.removeChild(input); };
             input.oncancel = () => { console.log("Legacy file input cancelled via event."); resolve(null); if (input.parentNode) document.body.removeChild(input); };
             input.style.display = 'none'; document.body.appendChild(input); input.click();
         });
     }


    /** Processes the selected file (from FSA or legacy) */
    async function handleFileOpenResult(fileData, fileHandle) {
        if (fileHandle && typeof fileHandle.isSameEntry === 'function') {
            let existingIndexByHandle = -1;
            for (let i = 0; i < files.length; i++) {
                if (files[i].handle && typeof files[i].handle.isSameEntry === 'function') {
                    try { if (await files[i].handle.isSameEntry(fileHandle)) { existingIndexByHandle = i; break; } } catch (e) { console.warn("Error comparing file handles:", e); }
                }
            }
            if (existingIndexByHandle !== -1) {
                console.log(`Switching to already open file (by handle): "${fileData.name}"`);
                setActiveFile(existingIndexByHandle);
                setStatusMessage(`Switched to ${fileData.name}`, false, STATUS_MESSAGE_DURATION); return;
            }
        }

        const existingIndexByName = files.findIndex(f => f.name === fileData.name);
        if (existingIndexByName !== -1) {
            if (confirm(`"${fileData.name}" is already open. Reload it from disk? (Unsaved changes will be lost)`)) {
                const content = fileHandle ? await fileData.text() : await readFileContentLegacy(fileData);
                files[existingIndexByName].content = content; files[existingIndexByName].unsaved = false; files[existingIndexByName].handle = fileHandle; files[existingIndexByName].language = getLanguageFromFileName(fileData.name);
                setActiveFile(existingIndexByName); console.log(`Reloaded "${fileData.name}" from disk.`); setStatusMessage(`Reloaded ${fileData.name}`, false, STATUS_MESSAGE_DURATION);
            } else {
                console.log(`Did not reload "${fileData.name}". Switching focus.`);
                setActiveFile(existingIndexByName); setStatusMessage(`Kept existing ${fileData.name}`, false, STATUS_MESSAGE_DURATION);
            }
            return;
        }

        const content = fileHandle ? await fileData.text() : await readFileContentLegacy(fileData);
        const language = getLanguageFromFileName(fileData.name);
        const newFile = { name: fileData.name, content: content, language: language, unsaved: false, handle: fileHandle };
        files.push(newFile); setActiveFile(files.length - 1); console.log(`Opened "${fileData.name}" as a new file.`); setStatusMessage(`Opened ${fileData.name}`, false, STATUS_MESSAGE_DURATION);
     }


    // --- Find & Replace Logic ---

    /** Toggles the visibility of the find/replace bar. */
    function toggleFindReplace(show) {
        if (!editor || !dom.findReplaceContainer) return;
        clearActiveSuggestion(false);
        const isVisible = dom.findReplaceContainer.style.display === 'flex';
        if (show && isVisible) { dom.findInput.focus(); dom.findInput.select(); return; }
        dom.findReplaceContainer.style.display = show ? "flex" : "none";
        if (show) { const selection = editor.getSelection(); if (selection) dom.findInput.value = selection; dom.findInput.focus(); dom.findInput.select(); } else { editor.focus(); }
    }

    /** Performs a find operation (next or previous). */
    function find(reverse = false) {
        if (!editor) return; const query = dom.findInput.value; if (!query) { setStatusMessage("Find: Please enter search text.", true, STATUS_MESSAGE_DURATION); return; }
        const caseSensitive = false; setStatusMessage(`Finding "${query}"...`);
        const searchCursor = editor.getSearchCursor(query, reverse ? editor.getCursor("from") : editor.getCursor("to"), { caseFold: !caseSensitive, reverse: reverse });
        if (!searchCursor.find(reverse)) {
            setStatusMessage(`"${query}" not found from cursor. Wrapping search...`, false, 1500);
            const startPos = reverse ? CodeMirror.Pos(editor.lastLine()) : CodeMirror.Pos(0, 0);
            const wrapCursor = editor.getSearchCursor(query, startPos, { caseFold: !caseSensitive, reverse: reverse });
            if (!wrapCursor.find(reverse)) { setStatusMessage(`"${query}" not found in document.`, true, STATUS_MESSAGE_DURATION); return; }
            editor.setSelection(wrapCursor.from(), wrapCursor.to()); editor.scrollIntoView({ from: wrapCursor.from(), to: wrapCursor.to() }, 50); setStatusMessage(`Found "${query}" (wrapped).`, false, STATUS_MESSAGE_DURATION);
        } else {
            editor.setSelection(searchCursor.from(), searchCursor.to()); editor.scrollIntoView({ from: searchCursor.from(), to: searchCursor.to() }, 50); setStatusMessage(`Found "${query}".`, false, STATUS_MESSAGE_DURATION);
        }
        dom.findInput.focus();
    }

    /** Replaces the current selection or finds the next match. */
    function replace() {
        if (!editor) return; const query = dom.findInput.value; const replacement = dom.replaceInput.value; const selection = editor.getSelection(); const caseSensitive = false;
        const selectionMatches = selection && (caseSensitive ? selection === query : selection.toLowerCase() === query.toLowerCase());
        if (selectionMatches) { editor.replaceSelection(replacement, "around"); setStatusMessage(`Replaced "${query}". Finding next...`, false, 1500); find(false); } else { setStatusMessage(`Selection doesn't match. Finding next "${query}"...`, false, 1500); find(false); }
        dom.replaceInput.focus();
    }

    /** Replaces all occurrences of the query in the document. */
    function replaceAll() {
        if (!editor) return; const query = dom.findInput.value; const replacement = dom.replaceInput.value; if (!query) { setStatusMessage("Replace All: Please enter search text.", true, STATUS_MESSAGE_DURATION); return; }
        const caseSensitive = false; let count = 0;
        editor.operation(() => { const cursor = editor.getSearchCursor(query, CodeMirror.Pos(0, 0), { caseFold: !caseSensitive }); while (cursor.findNext()) { cursor.replace(replacement); count++; } });
        setStatusMessage(`Replaced ${count} instance(s) of "${query}".`, false, STATUS_MESSAGE_DURATION); editor.focus();
    }


    // --- Theme Management ---

    /** Applies the selected theme to the editor and the overall UI. */
    function applyAppTheme(themeName) {
        const themeConfig = APP_THEMES[themeName]; if (!themeConfig) { console.error("Unknown theme:", themeName); return; }
        if (editor) { editor.setOption("theme", themeConfig.cm); }
        document.body.className = `theme-${themeConfig.type}`;
        currentAppTheme = themeName; console.log(`Applied theme: ${themeName} (UI: ${themeConfig.type}, Editor: ${themeConfig.cm})`); setStatusMessage(`Theme set to ${themeName}`, false, 2000);
        updateThemeMenuSelection();
    }

    /** Populates the theme selection submenu. */
    function populateThemeMenu() {
        if (!dom.themeMenu) return; dom.themeMenu.innerHTML = '';
        Object.keys(APP_THEMES).forEach(themeName => { const li = document.createElement('li'); li.className = 'submenu-item theme-option'; li.textContent = themeName; li.dataset.themeName = themeName; li.onclick = () => applyAppTheme(themeName); dom.themeMenu.appendChild(li); });
        updateThemeMenuSelection();
    }

    /** Updates the checkmark indicator in the theme selection submenu. */
    function updateThemeMenuSelection() {
        if (!dom.themeMenu) return; const items = dom.themeMenu.querySelectorAll('.theme-option');
        items.forEach(item => { const themeName = item.dataset.themeName; if (themeName === currentAppTheme) { item.textContent = `✓ ${themeName}`; item.style.fontWeight = 'bold'; } else { item.textContent = themeName; item.style.fontWeight = 'normal'; } });
    }

    // --- AI Suggestion Management ---

    /** Clears the currently active AI suggestion marker and optionally removes text. */
    function clearActiveSuggestion(accepted = false) {
        if (!activeSuggestionMarker) return;
        const marker = activeSuggestionMarker; const markerId = marker.id || Date.now(); activeSuggestionMarker = null;
        console.log(`Clearing suggestion marker ${markerId}. Accepted: ${accepted}`);
        const range = marker.find(); marker.clear();
        if (!accepted && range) { editor.replaceRange("", range.from, range.to, "+AIClear"); console.log(`Suggestion marker ${markerId} rejected and text removed.`); setStatusMessage("Suggestion dismissed", false, 2000); }
        else if (accepted && range) { editor.setCursor(range.to); setStatusMessage("Suggestion accepted", false, 2000); console.log(`Suggestion marker ${markerId} accepted.`); }
        else { console.log(`Suggestion marker ${markerId} dismissed (marker cleared).`); if (!accepted) setStatusMessage("Suggestion dismissed", false, 2000); }
        if (editor) editor.focus();
    }

    /** Fetches AI completion from the backend API. */
    // MODIFIED: Use appSettings for AI parameters
    async function fetchAICompletion(prompt) {
        setStatusMessage("AI thinking...");
        const apiUrlToUse = appSettings.apiUrl || DEFAULT_API_URL;

        try {
            // Use settings from appSettings object
            const requestBody = {
                prompt: prompt,
                n_predict: appSettings.aiMaxTokens,    // Use setting
                temperature: appSettings.aiTemperature, // Use setting
                top_k: appSettings.aiTopK,          // Use setting
                top_p: appSettings.aiTopP,          // Use setting
                stop: AI_COMPLETION_STOP_TOKENS
            };
             // Add top_k and top_p only if they are meaningfully set
            if (requestBody.top_k <= 0) delete requestBody.top_k;
            if (requestBody.top_p <= 0 || requestBody.top_p >= 1) delete requestBody.top_p;


            console.log("--- Sending Request Body ---");
            console.log(JSON.stringify(requestBody, null, 2));

            const response = await fetch(apiUrlToUse, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                 const errorText = await response.text();
                 console.error(`--- API Error Response (${response.status}) ---`);
                 console.error(errorText);
                 throw new Error(`API request failed: ${response.status} ${response.statusText} at ${apiUrlToUse}`);
            }

            const data = await response.json();
            console.log("--- Raw Response Data ---");
            console.log(JSON.stringify(data, null, 2));

            if (data && data.content) {
                let completionText = data.content.trim();
                // Clean stop tokens
                for (const stopWord of AI_COMPLETION_STOP_TOKENS) {
                    if (completionText.endsWith(stopWord)) {
                        completionText = completionText.slice(0, -stopWord.length).trimEnd();
                    }
                }
                 return completionText !== "" ? completionText : null;
            } else {
                console.warn("AI response format unexpected or 'content' field missing/empty:", data);
                return null;
            }
        } catch (error) {
            console.error("Fetch AI Completion failed:", error);
            throw new Error(`AI Error (${apiUrlToUse}): ${error.message}`);
        }
    }

    /** Triggers the AI completion process. */
    async function triggerAICompletion() {
        if (!editor) return; if (isAICompleting) { setStatusMessage("AI is already working...", true, 2000); return; }
        if (currentFileIndex < 0) { setStatusMessage("Open a file to use AI Completion", true, STATUS_MESSAGE_DURATION); return; }
        if (editor.getOption("readOnly")) { setStatusMessage("Cannot complete in read-only state", true, STATUS_MESSAGE_DURATION); return; }

        clearActiveSuggestion(false); isAICompleting = true;
        try {
            const cursor = editor.getCursor(); const contextLines = 15; const startLine = Math.max(0, cursor.line - contextLines);
            const textBeforeCursor = editor.getRange(CodeMirror.Pos(startLine, 0), cursor);
            const promptText = textBeforeCursor.slice(-AI_PROMPT_MAX_CHARS);
            const completion = await fetchAICompletion(promptText);

            if (completion) {
                const from = cursor; isInsertingAISuggestion = true; let marker;
                editor.operation(() => {
                    editor.replaceRange(completion, from, from, "+AICompletion"); const to = editor.getCursor();
                    if (CodeMirror.cmpPos(from, to) < 0) {
                         marker = editor.markText(from, to, { className: 'cm-ai-suggestion' }); activeSuggestionMarker = marker;
                         if (marker) { marker.on('clear', () => { if (activeSuggestionMarker && marker && activeSuggestionMarker.id === marker.id) { console.log(`Suggestion marker ${marker.id} cleared externally.`); activeSuggestionMarker = null; } }); }
                         setStatusMessage("AI Suggestion: Tab=Accept, Esc=Dismiss", false); console.log("AI Suggestion displayed:", completion);
                     } else { console.warn("AI Completion resulted in no change..."); setStatusMessage("AI returned no useful completion", false, STATUS_MESSAGE_DURATION); }
                });
            } else { console.warn("Completion was empty or null..."); setStatusMessage("AI returned no completion", false, STATUS_MESSAGE_DURATION); }
        } catch (error) { console.error("AI Completion Error:", error); setStatusMessage(`AI Error: ${error.message}`, true, 5000); clearActiveSuggestion(false); }
        finally { isAICompleting = false; isInsertingAISuggestion = false; if (dom.statusMessage && dom.statusMessage.textContent === "AI thinking...") { setStatusMessage(STATUS_MESSAGE_DEFAULT); } }
    }


    // --- Language Selection ---

    /** Populates the language selection submenu. */
    function populateLanguageMenu() {
        if (!dom.languageSubmenu) { console.error("Language submenu element not found."); return; }
        const parentLi = dom.languageSubmenu.closest('.menu-item'); if (!parentLi) { console.error("Parent menu item for language submenu not found."); return; }
        dom.languageSubmenu.innerHTML = '';
        const options = dom.languageSelect.options;
        for (let i = 0; i < options.length; i++) {
            const option = options[i]; const li = document.createElement('li'); li.className = 'submenu-item language-option'; li.textContent = option.text; li.dataset.langValue = option.value;
            li.onclick = (e) => { e.stopPropagation(); if (currentFileIndex >= 0) { setFileLanguage(option.value); } if (editor) editor.focus(); };
            dom.languageSubmenu.appendChild(li);
        }
        updateLanguageMenuSelection();
    }

    /** Sets the language mode for the current file and updates the editor. */
    function setFileLanguage(newLang, calledDuringSave = false) {
        if (!editor || currentFileIndex < 0 || !files[currentFileIndex]) return;
        const file = files[currentFileIndex]; if (file.language === newLang) return;
        clearActiveSuggestion(false); file.language = newLang;
        editor.setOption("mode", newLang); editor.setOption("lint", LINTABLE_MODES.includes(newLang));
        console.log(`Set language to ${newLang}. Linting: ${editor.getOption("lint")}`);
        const langOption = dom.languageSelect.querySelector(`option[value="${newLang}"]`); const langName = langOption ? langOption.text : newLang;
        setStatusMessage(`Language set to ${langName}`, false, STATUS_MESSAGE_DURATION);
        if (!calledDuringSave) { file.unsaved = true; }
        updateUIForFileStatus();
    }

    /** Updates the checkmark indicator in the language selection submenu. */
    function updateLanguageMenuSelection() {
        if (!dom.languageSubmenu) return; const items = dom.languageSubmenu.querySelectorAll('.language-option');
        const currentLang = (currentFileIndex >= 0 && files[currentFileIndex]) ? files[currentFileIndex].language : null;
        items.forEach(item => { const langValue = item.dataset.langValue; const optionEl = dom.languageSelect.querySelector(`option[value="${langValue}"]`); const optionText = optionEl ? optionEl.text : langValue; if (currentLang && langValue === currentLang) { item.textContent = `✓ ${optionText}`; item.style.fontWeight = 'bold'; } else { item.textContent = optionText; item.style.fontWeight = 'normal'; } });
    }


    // --- Event Handlers ---
    function handleNewFileClick() { dom.newFileNameInput.value = ""; dom.newFileLangSelect.value = "javascript"; openModal(dom.newFileModal); }
    function handleOpenFileClick() { openFile(); }
    function handleSaveClick() { if (dom.menuSave.dataset.enabled === 'true') saveFile(false); }
    function handleSaveAsClick() { if (dom.menuSaveAs.dataset.enabled === 'true') { if (currentFileIndex >= 0 && files[currentFileIndex]) { dom.saveAsFileNameInput.value = files[currentFileIndex].name; } else { dom.saveAsFileNameInput.value = ""; } openModal(dom.saveAsModal); } }
    function handleCloseFileClick() { if (dom.menuCloseFile.dataset.enabled === 'true' && currentFileIndex >= 0) removeFile(currentFileIndex); }
    function handleUndoMenuClick() { if (editor && dom.menuUndo.dataset.enabled === 'true') editor.undo(); }
    function handleRedoMenuClick() { if (editor && dom.menuRedo.dataset.enabled === 'true') editor.redo(); }
    function handleFindMenuClick() { toggleFindReplace(true); }
    function handleAICompleteMenuClick() { triggerAICompletion(); }
    function handleToggleLineNumbersClick() { if (editor) editor.setOption("lineNumbers", !editor.getOption("lineNumbers")); }
    function handleToggleWrappingClick() { if (editor) editor.setOption("lineWrapping", !editor.getOption("lineWrapping")); }
    function handleOpenSettingsClick() { populateSettingsModal(); openModal(dom.settingsModal); }
    function handleFindPrevClick() { find(true); }
    function handleFindNextClick() { find(false); }
    function handleReplaceClick() { replace(); }
    function handleReplaceAllClick() { replaceAll(); }
    function handleCloseFindClick() { toggleFindReplace(false); }
    function handleFindInputKeydown(e) { if (e.key === 'Enter') { e.preventDefault(); find(e.shiftKey); } else if (e.key === 'Escape') { toggleFindReplace(false); } }
    function handleReplaceInputKeydown(e) { if (e.key === 'Enter') { e.preventDefault(); replace(); } else if (e.key === 'Escape') { toggleFindReplace(false); } }
    function handleCreateNewFileConfirm() { const name = dom.newFileNameInput.value.trim(); const lang = dom.newFileLangSelect.value; let finalName = name; if (name && name.indexOf('.') === -1) { finalName = name + getSuggestedExtension(lang); } const finalLang = getLanguageFromFileName(finalName); if (createNewFileEntry(finalName, finalLang)) { closeModal(dom.newFileModal); } else { if (!name) dom.newFileNameInput.focus(); } }
    function handleSaveAsConfirm() { saveFile(true); }
    function handleEscapeKey(cm) { if (activeSuggestionMarker) { clearActiveSuggestion(false); return; } if (dom.findReplaceContainer.style.display !== 'none') { toggleFindReplace(false); return; } const openMenus = document.querySelectorAll('.menu-item:hover > ul.submenu'); if (openMenus.length > 0) { if (editor) editor.focus(); return; } const lintTooltips = document.querySelectorAll('.CodeMirror-lint-tooltip'); let closedTooltip = false; lintTooltips.forEach(tip => { if (tip && tip.parentNode) { tip.parentNode.removeChild(tip); closedTooltip = true; } }); if (closedTooltip) return; const openModalEl = document.querySelector('.modal.active'); if (openModalEl) { closeModal(openModalEl); return; } return CodeMirror.Pass; }
    function handleTabKey(cm) { if (activeSuggestionMarker) { clearActiveSuggestion(true); return; } return CodeMirror.Pass; }
    function handleBeforeUnload(event) { const hasUnsaved = files.some(file => file.unsaved); if (hasUnsaved) { const msg = 'You have unsaved changes. Are you sure you want to leave?'; event.preventDefault(); event.returnValue = msg; return msg; } }
    function handleModalBackdropClick(event) { if (event.target.classList.contains('modal') && event.target.classList.contains('active')) { closeModal(event.target); } }


    // --- Event Listener Setup ---
    function setupEventListeners() {
        document.getElementById("toolbar-new").addEventListener("click", handleNewFileClick);
        document.getElementById("toolbar-open").addEventListener("click", handleOpenFileClick);
        document.getElementById("toolbar-save").addEventListener("click", handleSaveClick);
        document.getElementById("toolbar-find").addEventListener("click", handleFindMenuClick);
        document.getElementById("menu-new").addEventListener("click", handleNewFileClick);
        document.getElementById("menu-open").addEventListener("click", handleOpenFileClick);
        document.getElementById("menu-save").addEventListener("click", handleSaveClick);
        document.getElementById("menu-saveas").addEventListener("click", handleSaveAsClick);
        document.getElementById("menu-closefile").addEventListener("click", handleCloseFileClick);
        document.getElementById("menu-undo").addEventListener("click", handleUndoMenuClick);
        document.getElementById("menu-redo").addEventListener("click", handleRedoMenuClick);
        document.getElementById("menu-find").addEventListener("click", handleFindMenuClick);
        document.getElementById("menu-ai-complete").addEventListener("click", handleAICompleteMenuClick);
        document.getElementById("menu-toggle-linenumbers").addEventListener("click", handleToggleLineNumbersClick);
        document.getElementById("menu-toggle-wrapping").addEventListener("click", handleToggleWrappingClick);
        document.getElementById("menu-preferences").addEventListener("click", handleOpenSettingsClick);
        document.getElementById("findPrevBtn").addEventListener("click", handleFindPrevClick);
        document.getElementById("findNextBtn").addEventListener("click", handleFindNextClick);
        document.getElementById("replaceBtn").addEventListener("click", handleReplaceClick);
        document.getElementById("replaceAllBtn").addEventListener("click", handleReplaceAllClick);
        document.getElementById("closeFindBtn").addEventListener("click", handleCloseFindClick);
        dom.findInput.addEventListener('keydown', handleFindInputKeydown);
        dom.replaceInput.addEventListener('keydown', handleReplaceInputKeydown);
        document.getElementById("closeNewFileModal").addEventListener("click", () => closeModal(dom.newFileModal));
        document.getElementById("cancelNewFile").addEventListener("click", () => closeModal(dom.newFileModal));
        document.getElementById("createNewFile").addEventListener("click", handleCreateNewFileConfirm);
        document.getElementById("closeSaveAsModal").addEventListener("click", () => closeModal(dom.saveAsModal));
        document.getElementById("cancelSaveAs").addEventListener("click", () => closeModal(dom.saveAsModal));
        document.getElementById("confirmSaveAs").addEventListener("click", handleSaveAsConfirm);
        document.getElementById("closeSettingsModal").addEventListener("click", () => closeModal(dom.settingsModal));
        document.getElementById("cancelSettings").addEventListener("click", () => closeModal(dom.settingsModal));
        document.getElementById("saveSettings").addEventListener("click", handleSaveSettingsClick);

        dom.newFileNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateNewFileConfirm(); });
        dom.newFileLangSelect.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateNewFileConfirm(); });
        dom.saveAsFileNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveAsConfirm(); });
        dom.settingFontSize.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveSettingsClick(); });
        dom.settingTabSize.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveSettingsClick(); });
        dom.settingIndentType.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveSettingsClick(); });
        dom.settingApiUrl.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveSettingsClick(); });
        // NEW: Enter listeners for AI settings
        dom.settingAiTemp.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveSettingsClick(); });
        dom.settingAiTopK.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveSettingsClick(); });
        dom.settingAiTopP.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveSettingsClick(); });
        dom.settingAiMaxTokens.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSaveSettingsClick(); });

        window.addEventListener('beforeunload', handleBeforeUnload);
        window.addEventListener('click', handleModalBackdropClick);
    }

    // --- App Entry Point ---
    document.addEventListener('DOMContentLoaded', initApp);

})(); // End IIFE
</script>
</body>
</html>